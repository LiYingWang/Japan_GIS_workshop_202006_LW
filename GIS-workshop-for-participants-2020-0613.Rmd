---
title: "Making maps and analysing spatial data: An introduction to using R for archaeologists"
author: "Liying Wang"
date: "6/14/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

In this workshop, we will learn how to use R to manipulate and visualize spatial data of interest to archaeologists. This rmd file is a demonstration of code and you will work on it step by step to get familiar with spatial data and basic analysis. There are three main topics covered in this workshop:

-Part 1: making maps, including regional map and site map
-Part 2: learning raster data and vector data, spatial data manipulation, and visualization
-Part 3: density analysis of sites and hypothesis testing for their distributions

Before getting started, let's install all packages we will use!
 
# Exercise: install packages (3 mins) 

```{r install-packages}
install.packages(c("rnaturalearth", 
                   "rnaturalearthdata", 
                   "tidyverse", 
                   "sf", 
                   "sp",
                   "shadowtext", 
                   "ggmap", 
                   "ggspatial", 
                   "raster", 
                   "spatstat", 
                   "maptools"))
devtools::install_github('3wen/legendMap')
```

-Part 1: making maps, including regional map and site map

Load world data and take a look at the data form, especially the "geometry" column where it stores the coordinates we needs for making maps

# Exercise: loading data and check it (2 mins)

```{r load-world-map-data}
library(rnaturalearth) # provides world map
library(rnaturalearthdata)

world <- ne_countries(scale = "medium", returnclass = "sf") # this line pulls country data 
class(world) # what class it is?
# type View(world) in your console to take a look at the data frame
```

# Exercise: plot the world map (2 mins)

```{r plot-world-map}
library(ggplot2)

# plot basic world map 
ggplot(data = world) +
  geom_sf() + # adds a geometry stored in world
  theme_minimal()
```

Now, we want to plot Japan with some countries around it as our regional map. We may want to indicate the countries by adding name label on it. To do this, we need to get the center of the country for adding country labels, and then specify which countries we want to show their names on the map.

# Exercise: create country labels to add on the regional map (2 mins)

```{r create-text-labels}
library(tidyverse)
library(sf)

country_centre_coords <-
  as_tibble(st_coordinates(st_centroid(world$geometry))) # for the text labels

world_points <-
  world %>%
  bind_cols(country_centre_coords) %>%
  filter(name %in% c("Japan", "China", "Korea", "Taiwan", "Russia",
                     "Philippines", "Vietnam", "Mongolia"))
```

# Exercise: make a regional map (5 mins)

```{r regional-map-with-labels}
library(shadowtext)

JP_NE_Asia <-
  ggplot(data = world) +
  geom_sf() +
  geom_shadowtext(data= world_points,
                  aes(x = X, y = Y,
                      label = name),
                  color='black',
                  bg.colour='white',
                  size = 3,
                  position = position_nudge(y = 0, x = 3)) +
  coord_sf(xlim = c(95, 175), # zoom in the area of interest
           ylim = c(8, 70), 
           expand = FALSE) + # match the limits we provide
  scale_x_continuous(breaks = seq(100, 160, by = 20)) +
  scale_y_continuous(breaks = seq(20, 65, by = 20)) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank())

JP_NE_Asia
```

We also want to make a map for archaeological sites we are interested in. We need to specify the coordinates of site location.

# Exercise: prepare the location of sites (2 mins)

```{r site-location}
# add site location
site_location <-
  data.frame(location = c("Daisen Kofun", "Todai-ji temple"),
             lon = c(135.487953, 135.839891),
             lat = c(34.564503, 34.688862))
```

# Exercise: make a site map (7 mins)

```{r site-location-map}
library(ggmap)
library(ggspatial)
library(legendMap)

local_map <- ggmap(get_stamenmap(rbind(as.numeric(c(135.3, 34.3,
                                                    136.0, 35))), zoom = 10))

site_Japan <- 
  local_map +
  geom_point(data = site_location,
             aes(x = lon,
                 y = lat),
             size = 2,
             color = "red") +
  geom_shadowtext(data = site_location,
                  aes(x = lon,
                      y = lat,
                      label = location),
                  size = 3,
                  position = position_nudge(y = - 0.03),
                  check.overlap = TRUE) +
  coord_sf(xlim = c(135.3, 136),
           ylim = c(34.3, 35),
           expand = FALSE) +
  scale_x_continuous(breaks = seq(135.3, 136, by = 0.2)) +
  scale_y_continuous(breaks = seq(24.3, 35, by = 0.2)) +
  legendMap::scale_bar(
    lon = 135.75,
    lat = 34.32,
    legend_size = 2,
    # distance of one section of scale bar, in km
    distance_lon = 10,
    # height of the scale bar, in km
    distance_lat = 1,
    # distance between scale bar and units, in km
    distance_legend = 3,
    # units of scale bar
    dist_unit = "km",
    # add the north arrow
    orientation = TRUE,
    # length of N arrow, in km
    arrow_length = 5,
    # distance between scale bar & base of N arrow, in km
    arrow_distance = 3,
    # size of letter 'N' on N arrow, in km
    arrow_north_size = 3) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank())

site_Japan
```

The final step is to save our plot! Use this code right below the plot you want to save. 

# Exercise: save the map to your folder (2 mins)

```{r save-map}
ggsave(here::here("Japan-site-map.jpg"),
       width = 60,
       height = 60,
       dpi = 300,
       units = "mm")
```

-Part 2: learning raster data and vector data, spatial data manipulation, and visualization
The raster data is DEM downloaded from https://www.gsi.go.jp/kankyochiri/gm_japan_e.html. We won't use the data, so we need to crop the area we want.

# Exercise: crop an area from raster data (7 mins)

```{r get-raster-data}
library(raster)

# download the zip file into our data folder
download.file("https://github.com/LiYingWang/Japan_GIS_workshop_202006_LW/raw/master/data/gm-jpn-el_u_1_1.zip", "data/raster-data.zip")
# unzip to the data folder
unzip(zipfile = "data/raster-data.zip", exdir = "data")
# delete zip file
unlink("data/raster-data.zip")
# read in data from data folder
DEM_Japan <- raster(here::here("gm-jpn-el_u_1_1", "jpn", "el.tif"))

# assign coordinate reference system
crs(DEM_Japan) <- "+proj=lcc +lat_1=41.03333333333333 +lat_2=40.66666666666666 +lat_0=40.16666666666666 +lon_0=-74 +x_0=300000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=us-ft +no_defs"

plot(DEM_Japan) # take a look at raster data

# define the area that we want to crop from the DEM
x_coord <- c(135.3, 135.3, 136, 136, 135.3)
y_coord <- c(34.3, 35, 35, 34.3, 34.3)
xym <- cbind(x_coord, y_coord)

library(sp)
p = Polygon(xym) # convert the matrix to polygon
ps = Polygons(list(p),1) # make lists
sps = SpatialPolygons(list(ps)) # convert to Spatial Polygons
crs(sps) <- crs(DEM_Japan) # make them the same coordinate system
crop_DEM <- crop(DEM_Japan, sps) # crop the area we want from DEM
summary(crop_DEM)
```

# Exercise: convert raster data to a data frame for plotting (5 mins)

```{r plot-raster-data}
crop_DEM_df <- as.data.frame(crop_DEM, xy = TRUE)

# plot
ggplot() +
  geom_raster(data = crop_DEM_df , aes(x = x, y = y, fill = el)) +
  scale_fill_viridis_c(name = "Elevation") +
  coord_quickmap()
```

Now, let's work on vector data. We download the shapefile which contains site locations we want to explore. We are curious about the distribution of sites and how it relates to the elevation of this area. 

# Exercise: explore shapefile and map it on the raster layer (7 mins)

```{r read-shapefile}
# download the zip file into our data folder
download.file("https://github.com/LiYingWang/Japan_GIS_workshop_202006_LW/raw/master/shapefile/shapefile.zip", "data/site_shapefile.zip")
# unzip to the data folder
unzip(zipfile = "data/site_shapefile.zip", exdir = "data")
# delete zip file
unlink("data/site_shapefile.zip")

sites_location <- st_read(here::here("data","sites_example.shp"))

ggplot() +
  geom_raster(data = crop_DEM_df, aes(x = x, y = y, fill = el)) +
  geom_sf(data = sites_location, aes(color = Period)) +
  scale_color_manual(values=c("red", "black")) +
  scale_fill_viridis_c(name = "Elevation") +
  coord_sf()
```

We are curious about the elevation where the archaeological sites are located, and would like to compare sites from two phases: Yayoi and Kofun

# Exercise: extract elevation and make a boxplot to compare sites from two phases (5 mins)

```{r elevation-boxplot-two-phases}
# convert sf to a sptaial object
sp_sites_location <- as(sites_location, "Spatial")

# extract elevation for each site
elevation <- extract(crop_DEM, sp_sites_location, method = "simple")
sites_location <- cbind(sites_location, elevation)

sites_location %>% 
  ggplot (aes (Period, elevation)) +
  geom_boxplot() +
  theme_minimal()
```

-Part 3: density analysis of sites and hypothesis testing for their distributions

What is the distribution of the sites across this area? We want to see if there are any hot spots using kernal density estimation.

# Exercise: make a kernel density plot (7 mins)  

```{r kernel-plot-all-sites}
library(spatstat)
library(maptools)

sites_location_coords <-
  sites_location %>% 
  st_coordinates() %>% 
  as.data.frame 

plot(sites_location_coords)

sites_location_ppp <- ppp(x = sites_location_coords$X,
                          y = sites_location_coords$Y,
                          range(sites_location_coords$X), # set range
                          range(sites_location_coords$Y))

K1 <- density(sites_location_ppp) 

plot(K1, main=NULL, las=1)
contour(K1, add=TRUE)
```

Is the hot spots we observed significant? We can simulate the site locations and make hypothesis testing to determine if the distribution is clustered or dispersed. 

# Exercise: simulation and plot the histogram (7 mins)

```{r simulation-all-sites}
ann_p <- mean(nndist(sites_location_ppp, k=1))
n     <- 1000 # Number of simulations

ann_r <- vector(length = n) # an object for storing simulated ANN values

# simulation
for (i in 1:n){
  rand_p   <- rpoint(sites_location_ppp$n, 
                     win = as.owin(crop_DEM_df))  # Generate random point locations
  ann_r[i] <- mean(nndist(rand_p, k=1))  # Tally the ANN values
}

# plot the histogram and add our observed ANN value line
hist(ann_r, main=NULL, las=1, breaks=40, 
     col = "bisque", 
     xlim = range(ann_p, ann_r))
abline(v = ann_p, col="blue")
```

We looked at sites all together and now we want to only explore Kofun period. We first separate the phases and then use the same method to test the Kofun sites.

# Quiz: Do the Kofun sites ramdonly distributed or non-ramdonly distribution? The pattern is clustterd or dispersed? 

```{r kernel-plot-kofun}
sites_location_coords_kofun <-
  sites_location %>% 
  st_coordinates() %>% 
  as.data.frame () %>% 
  bind_cols(sites_location) %>% 
  filter(Period == "Kofun")

sites_location_ppp_kofun <- (ppp(x = sites_location_coords_kofun$X,
                                 y = sites_location_coords_kofun$Y,
                                 range(sites_location_coords$X),
                                 range(sites_location_coords$Y))) 

K2 <- density(sites_location_ppp_kofun) 

plot(K2, main=NULL, las=1)
contour(K2, add=TRUE)
```

```{r simulation-kofun}
ann_p <- mean(nndist(sites_location_ppp_kofun, k=1))
n     <- 1000 # Number of simulations

ann_r <- vector(length = n) # an object for storing simulated ANN values

# simulation
for (i in 1:n){
  rand_p   <- rpoint(sites_location_ppp_kofun$n, 
                     win = as.owin(crop_DEM_df))  # Generate random point locations
  ann_r[i] <- mean(nndist(rand_p, k=1))  # Tally the ANN values
}

# plot the histogram and add our observed ANN value line
hist(ann_r, main=NULL, las=1, breaks=40, 
     col = "bisque", 
     xlim = range(ann_p, ann_r))
abline(v = ann_p, col="blue")
```