---
title: "Working with spatial data using R for archaeologists"
author: "Liying Wang"
date: "6/5/2020"
output: html_document
---
Opening: introduce myself
Learning goal: get familiar with using R to work on spatial data
The content of this workshop: two parts of learning activities, slide, demonstration, hand-on 
exercise 
packages we use in this workshop (5 mins)

Part 1: making maps suitable for excavation report and publication (40 mins)
- loading packages
- read world map
- define the region
- plotting
- add labels on the map

Part 2: deal with spatial data in archaeology (75 mins) 
- packages
- introduction of spatial data: vector and raster(?)
- reading data into R
- join data sets
- data visualization
- mapping the spatial data
- hypothesis testing
- coordinate reference systems (CRS)?

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Install all packages (provides a list) and brief introduction for each package
Demonstration of loading world data, and explain the data, especially the geometry column  (5 mins)
Exercise: loading data (2 mins)

```{r load-world-map-data}
library(rnaturalearth) # provides world map
library(rnaturalearthdata)

world <- ne_countries(scale = "medium", returnclass = "sf") # pull contry data 
class(world) # see what class it is
View(world) # take a look at the data
```

Demonstration of making world map, explain each line (5 mins)
Exercise: plot the world map (2 mins)

```{r plot-world-map}
library(ggplot2)

# plot basic world map 
ggplot(data = world) +
  geom_sf() + # adds a geometry stored in the world object
  theme_minimal()
```

select countries we want to show the text, demonstrate and explain each line (5 mins)
Exercise: make a regional map (7 mins), combining two chunks

```{r create-labels-on-map}
library(tidyverse)
library(sf)
world_points <- st_centroid(world) # for the text labels

world_points <-
  world %>%
  bind_cols(st_coordinates(st_centroid(world$geometry))) %>%
  filter(name %in% c("Japan", "China", "Korea", "Taiwan", "Russia",
                     "Philippines", "Vietnam", "Mongolia"))

```

```{r Japan-regional-map}
library(shadowtext)
JP_NE_Asia <-
  ggplot(data = world) +
  geom_sf() +
  geom_shadowtext(data= world_points,
                  aes(x = X, y = Y,
                      label = name),
                  color='black',
                  bg.colour='white',
                  size = 3,
                  position = position_nudge(y = 0, x = 3)) +
  coord_sf(xlim = c(95, 175), # zoom in the area of interest
           ylim = c(8, 70), 
           expand = FALSE) + # match the limits we provide
  scale_x_continuous(breaks = seq(100, 160, by = 20)) +
  scale_y_continuous(breaks = seq(20, 65, by = 20)) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank())
```

define site location, demonstrate and explain each line (5 mins)
Exercise: make a site map (7 mins), combine two chunks 

```{r site-location}
# add site location
site_location <-
  data.frame(location = c("Daisen Kofun", "Todai-ji temple"),
             lon = c(135.487953, 135.839891),
             lat = c(34.564503, 34.688862))
```

```{r site-location-map}
library(ggmap)
library(ggspatial)
library(legendMap)
# devtools::install_github('3wen/legendMap')
local_map <- ggmap(get_stamenmap(rbind(as.numeric(c(135.3, 34.3,
                                                    136.0, 35))), zoom = 10))

site_Japan <- 
  local_map +
  geom_point(data = site_location,
             aes(x = lon,
                 y = lat),
             size = 2,
             color = "red") +
  geom_shadowtext(data = site_location,
                  aes(x = lon,
                      y = lat,
                      label = location),
                  size = 3,
                  position = position_nudge(y = - 0.03),
                  check.overlap = TRUE) +
  coord_sf(xlim = c(135.3, 136),
           ylim = c(34.3, 35),
           expand = FALSE) +
  scale_x_continuous(breaks = seq(135.3, 136, by = 0.2)) +
  scale_y_continuous(breaks = seq(24.3, 35, by = 0.2)) +
  legendMap::scale_bar(
    lon = 135.75,
    lat = 34.32,
    legend_size = 2,
    # distance of one section of scale bar, in km
    distance_lon = 10,
    # height of the scale bar, in km
    distance_lat = 1,
    # distance between scale bar and units, in km
    distance_legend = 3,
    # units of scale bar
    dist_unit = "km",
    # add the north arrow
    orientation = TRUE,
    # length of N arrow, in km
    arrow_length = 5,
    # distance between scale bar & base of N arrow, in km
    arrow_distance = 3,
    # size of letter 'N' on N arrow, in km
    arrow_north_size = 3) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank())
```

save your plot
Exercise: save the map to your folder (2 mins)

```{r save-map}
ggsave(here::here("Japan-site-map.jpg"),
       width = 60,
       height = 60,
       dpi = 300,
       units = "mm")
```

Introduction of vector and raster data (7 mins)
download raster data for Japan: https://www.gsi.go.jp/kankyochiri/gm_japan_e.html (1 mins)
Exercise: crop the area we want and plot it (7 mins)

```{r get-raster-data}
library(raster)

# download the zip file into our data folder
download.file("https://github.com/LiYingWang/Japan_GIS_workshop_202006_LW/blob/master/data/gm-jpn-el_u_1_1.zip", "data/raster-data.zip")
# unzip to the data folder
unzip(zipfile = "data/raster-data.zip", exdir = "data")
# delete zip file
unlink("data/raster-data.zip")
# read in data from data folder
DEM_Japan <- raster(here::here("gm-jpn-el_u_1_1", "jpn", "el.tif"))

# assign coordinate reference system
crs(DEM_Japan) <- "+proj=lcc +lat_1=41.03333333333333 +lat_2=40.66666666666666 +lat_0=40.16666666666666 +lon_0=-74 +x_0=300000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=us-ft +no_defs"

plot(DEM_Japan) # take a look at raster data

# crop the DEM area of the site from scratch 
x_coord <- c(135.3, 135.3, 136, 136, 135.3)
y_coord <- c(34.3, 35, 35, 34.3, 34.3)
xym <- cbind(x_coord, y_coord)

library(sp)
p = Polygon(xym)
ps = Polygons(list(p),1)
sps = SpatialPolygons(list(ps))
crs(sps) <- crs(DEM_Japan) 
crop_DEM <- crop(DEM_Japan, sps)
summary(crop_DEM)
```

we want to crop the area we want (2 mins), demostrate the layers
Exercise: convert to data frame for ggplot, and then plot the cropped raster data (5 mins)
```{r plot-raster-data}
crop_DEM_df <- as.data.frame(crop_DEM, xy = TRUE)

# plot
ggplot() +
  geom_raster(data = crop_DEM_df , aes(x = x, y = y, fill = el)) +
  scale_fill_viridis_c(name = "Elevation") +
  coord_quickmap()
```

talk about sahpefile, read and add the shapefile (site location) onto raster data (7 mins)
Exercise: map shapefile and the DEM raster layer (5 mins)

```{r read-shapefile}
sites_location <- st_read(here::here("sites_example.shp"))

ggplot() +
  geom_raster(data = crop_DEM_df, aes(x = x, y = y, fill = el)) +
  geom_sf(data = sites_location, aes(color = Period)) +
  scale_color_manual(values=c("red", "black")) +
  scale_fill_viridis_c(name = "Elevation") +
  coord_sf()
```

demonstrate how to extract the elevation for each site (5 mins)
Exercise: extract elevation and make a boxplot to compare different phases (5 mins)

```{r}
# convert sf to a sptaial object
sp_sites_location <- as(sites_location, "Spatial")

# extract elevation for each site
elevation <- extract(crop_DEM, sp_sites_location, method = "simple")
sites_location <- cbind(sites_location, elevation)
```

```{r elevation-boxplot}
sites_location %>% 
  ggplot (aes (Period, elevation)) +
  geom_boxplot() +
  theme_minimal()
```

density analysis and tell us the distribution of site, cover issue of missing data (5 mins)
point pattern analysis, kernel density analysis tells us the pattern (5 mins)
Exercise: create object and plot kernel density plot (7 mins)  

```{r}
library(spatstat)
library(maptools)

sites_location_coords <-
  sites_location %>% 
  st_coordinates() %>% 
  as.data.frame 

plot(sites_location_coords)

sites_location_ppp <- ppp(x = sites_location_coords$X,
                          y = sites_location_coords$Y,
                          range(sites_location_coords$X), # set range
                          range(sites_location_coords$Y))

K1 <- density(sites_location_ppp) 

plot(K1, main=NULL, las=1)
contour(K1, add=TRUE)
```

hypothesis testing to determine the distribution is random or non-random (5 mins)
Exercise: simulation and plot the histogram (7 mins)

```{r}
ann_p <- mean(nndist(sites_location_ppp, k=1))
n     <- 1000 # Number of simulations

ann_r <- vector(length = n) # an object for storing simulated ANN values

# simulation
for (i in 1:n){
  rand_p   <- rpoint(sites_location_ppp$n, 
                     win = as.owin(crop_DEM_df))  # Generate random point locations
  ann_r[i] <- mean(nndist(rand_p, k=1))  # Tally the ANN values
}

# plot the histogram and add our observed ANN value line
hist(ann_r, main=NULL, las=1, breaks=40, 
     col = "bisque", 
     xlim = range(ann_p, ann_r))
abline(v = ann_p, col="blue")
```

only Look at only Kofun period

```{r}
sites_location_coords_kofun <-
  sites_location %>% 
  st_coordinates() %>% 
  as.data.frame () %>% 
  bind_cols(sites_location) %>% 
  filter(Period == "Kofun")

sites_location_ppp_kofun <- (ppp(x = sites_location_coords_kofun$X,
                                 y = sites_location_coords_kofun$Y,
                                 range(sites_location_coords_kofun$X),
                                 range(sites_location_coords_kofun$Y))) 

K2 <- density(sites_location_ppp_kofun) 

plot(K2, main=NULL, las=1)
contour(K2, add=TRUE)
```

```{r}
ann_p <- mean(nndist(sites_location_ppp_kofun, k=1))
n     <- 1000 # Number of simulations

ann_r <- vector(length = n) # an object for storing simulated ANN values

# simulation
for (i in 1:n){
  rand_p   <- rpoint(sites_location_ppp_kofun$n, 
                     win = as.owin(crop_DEM_df))  # Generate random point locations
  ann_r[i] <- mean(nndist(rand_p, k=1))  # Tally the ANN values
}

# plot the histogram and add our observed ANN value line
hist(ann_r, main=NULL, las=1, breaks=40, 
     col = "bisque", 
     xlim = range(ann_p, ann_r))
abline(v = ann_p, col="blue")
```